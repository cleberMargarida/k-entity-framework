# ci.yml
#
# Continuous Integration for pull requests and feature/topic branches.
#
# Jobs
# ────
#   build             – compile the solution
#   unit-tests        – run unit tests, collect Cobertura coverage
#   integration-tests – run integration tests, collect coverage, post PR comment
#                       skipped when the PR title or commit message contains
#                       [skip-integration]

name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches-ignore:
      - master

jobs:
  # ── 1. Build ─────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET and build
        uses: ./.github/actions/dotnet-setup

  # ── 2. Unit Tests ─────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET and build
        uses: ./.github/actions/dotnet-setup

      - name: Run unit tests
        run: >
          dotnet test tests/K.EntityFrameworkCore.UnitTests/
          --no-build
          --collect:"XPlat Code Coverage"
          --results-directory coverage/unit
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude="[K.EntityFrameworkCore.CodeGen]*"

      - name: Generate unit test coverage report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/unit/**/*.cobertura.xml
          badge: true
          format: markdown
          output: both
          tag: unit-tests

      - name: Upload unit coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/unit/**/*.cobertura.xml
          flags: unit-tests
          name: unit-tests
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Write unit test coverage to job summary
        run: |
          echo "## Unit Test Coverage" >> "$GITHUB_STEP_SUMMARY"
          cat code-coverage-results.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload unit coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-report
          path: code-coverage-results.md
          if-no-files-found: warn

  # ── 3. Integration Tests ──────────────────────────────────────────────────────
  integration-tests:
    name: Integration Tests
    needs: [unit-tests]
    runs-on: ubuntu-latest

    # Skip when PR title or commit message contains [skip-integration].
    if: |
      !(github.event_name == 'pull_request' &&
        contains(github.event.pull_request.title, '[skip-integration]')) &&
      !(github.event_name == 'push' &&
        contains(github.event.head_commit.message, '[skip-integration]'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET and build
        uses: ./.github/actions/dotnet-setup

      - name: Run integration tests
        run: >
          dotnet test tests/K.EntityFrameworkCore.IntegrationTests/
          --no-build
          --collect:"XPlat Code Coverage"
          --results-directory coverage/integration
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Exclude="[K.EntityFrameworkCore.CodeGen]*"

      - name: Generate integration test coverage report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/integration/**/*.cobertura.xml
          badge: true
          format: markdown
          output: both
          tag: integration-tests

      - name: Upload integration coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/integration/**/*.cobertura.xml
          flags: integration-tests
          name: integration-tests
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Write integration test coverage to job summary
        run: |
          echo "## Integration Test Coverage" >> "$GITHUB_STEP_SUMMARY"
          cat code-coverage-results.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload integration coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage-report
          path: code-coverage-results.md
          if-no-files-found: warn

      # Post a single sticky comment on the PR containing both coverage summaries.
      - name: Download unit coverage artifact
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: unit-coverage-report
          path: ./unit-report

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          header: coverage-report
          message: |
            ## Test Coverage Report

            ### Unit Tests
            ${{ hashFiles('./unit-report/code-coverage-results.md') != '' && '<!-- unit coverage below -->' || 'Coverage report not available.' }}

            ### Integration Tests
            <!-- integration coverage below -->

            > Full details are available in the [job summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
